<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 校园活动平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: #667eea;
            margin-bottom: 20px;
            overflow: hidden;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .stats-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            color: #666;
            font-weight: 500;
            border: none;
            padding: 12px 24px;
            margin-right: 10px;
        }
        .nav-tabs .nav-link:hover {
            color: #667eea;
        }
        .nav-tabs .nav-link.active {
            color: #667eea;
            background-color: transparent;
            border-bottom: 3px solid #667eea;
        }
        .activity-card {
            border: none;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .activity-card:hover {
            transform: translateY(-2px);
        }
        .badge-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: normal;
            padding: 5px 12px;
            border-radius: 20px;
        }
        .badge-teacher {
            background-color: #dc3545;
            color: white;
        }
        .badge-student {
            background-color: #28a745;
            color: white;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .avatar-upload {
            cursor: pointer;
            transition: all 0.3s;
        }
        .avatar-upload:hover {
            transform: scale(1.05);
        }
        .completion-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .completion-item.completed {
            background: #e7f7ef;
            color: #28a745;
        }
        .profile-actions {
            margin-top: 20px;
        }
        .profile-actions .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .avatar-upload-btn {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        .avatar-upload-btn input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .teacher-exclusive {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 导航栏：修复图标格式+规整布局，保留所有功能 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-school text-primary"></i>
                校园活动平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-1"></i> 首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/personal_home">
                            <i class="fas fa-user-circle me-1"></i> 我的首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/profile">
                            <i class="fas fa-user me-1"></i> 个人中心
                        </a>
                    </li>
                    <!-- 教师专属导航：保留原有标识和路径，仅优化格式 -->
                    <li class="nav-item teacher-exclusive" id="reviewNavItem">
                        <a class="nav-link" href="/teacher/review">
                            <i class="fas fa-gavel me-1"></i> 帖子审核
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i> 退出
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container profile-container">
        <!-- 个人资料头部 -->
        <div class="profile-header">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <div class="profile-avatar mx-auto" onclick="document.getElementById('avatarUploadMain').click()">
                        <i class="fas fa-user" id="avatarIcon"></i>
                        <img id="avatarPreview" src="" alt="头像" style="display: none;">
                    </div>
                    <div class="avatar-upload-btn mt-2">
                        <button class="btn btn-light btn-sm">
                            <i class="fas fa-camera"></i> 更换头像
                        </button>
                        <input type="file" id="avatarUploadMain" accept="image/*" onchange="previewAvatar(this)">
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 id="usernameDisplay" class="mb-1">用户</h2>
                            <p class="mb-2" id="userEmail"></p>
                            <p class="mb-2" id="userInfo">
                                <span id="userMajor"></span>
                                <span id="userGrade" class="ms-2"></span>
                            </p>
                            <p class="mb-0" id="userBio"></p>
                        </div>
                        <div class="text-end">
                            <span class="badge mb-2" id="userRoleBadge">普通用户</span>
                            <p class="text-light mb-0"><small>注册时间: <span id="joinDate"></span></small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 统计信息 -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <h1 class="display-4 text-primary" id="joinedCount">0</h1>
                        <p class="text-muted">参与活动</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <h1 class="display-4 text-success" id="totalActivities">0</h1>
                        <p class="text-muted">活动总数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <h1 class="display-4 text-warning" id="favoritesCount">0</h1>
                        <p class="text-muted">收藏活动</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card h-100">
                    <div class="card-body text-center">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h1 class="display-4 text-info mb-0" id="accountDays">0</h1>
                            <div id="profileCompletion" class="h4 mb-0">0%</div>
                        </div>
                        <p class="text-muted">注册天数 / 资料完整度</p>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" id="completionBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 标签页 -->
        <ul class="nav nav-tabs mb-4" id="profileTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="joined-tab" data-bs-toggle="tab" data-bs-target="#joined">
                    <i class="fas fa-calendar-check"></i> 我参与的活动
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="favorites-tab" data-bs-toggle="tab" data-bs-target="#favorites">
                    <i class="fas fa-star"></i> 收藏的活动
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="my-posts-tab" data-bs-toggle="tab" data-bs-target="#my-posts">
                    <i class="fas fa-file-alt"></i> 我的帖子
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings">
                    <i class="fas fa-cog"></i> 账户设置
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="detailed-tab" data-bs-toggle="tab" data-bs-target="#detailed">
                    <i class="fas fa-edit"></i> 个人资料
                </button>
            </li>
        </ul>
        <!-- 标签页内容 -->
        <div class="tab-content" id="profileTabContent">
            <!-- 已参与活动 -->
            <div class="tab-pane fade show active" id="joined">
                <div id="joinedActivitiesList" class="row">
                    <!-- 已参与的活动将通过JS动态加载 -->
                </div>
                <div class="text-center py-4" id="joinedLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载您的活动...</p>
                </div>
            </div>
            <!-- 收藏的活动 -->
            <div class="tab-pane fade" id="favorites">
                <div id="favoritesList" class="row">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            点击活动卡片上的星星图标可以收藏活动
                        </div>
                    </div>
                </div>
                <div class="text-center py-4" id="favoritesLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载收藏的活动...</p>
                </div>
            </div>
            <!-- 我的帖子 -->
            <div class="tab-pane fade" id="my-posts">
                <div class="row mb-3">
                    <div class="col-12">
                        <a href="/" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> 发布新帖子
                        </a>
                    </div>
                </div>
                <div id="myPostsList" class="row">
                    <!-- 我的帖子将通过JS动态加载 -->
                </div>
                <div class="text-center py-4" id="postsLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载我的帖子...</p>
                </div>
            </div>
            <!-- 账户设置 -->
            <div class="tab-pane fade" id="settings">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-user-circle"></i> 基本信息
                                </h5>
                                <form id="profileForm">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">邮箱地址</label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="joinDate" class="form-label">注册日期</label>
                                        <input type="text" class="form-control" id="joinDateSettings" readonly>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> 保存更改
                                    </button>
                                    <div id="profileMessage" class="mt-2"></div>
                                </form>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-shield-alt"></i> 账户安全
                                </h5>
                                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                    <i class="fas fa-key"></i> 修改密码
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">资料完整度</h5>
                                <div id="profileChecklist" class="mt-3">
                                    <!-- 完整度检查项将通过JS动态加载 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 个人详细资料 -->
            <div class="tab-pane fade" id="detailed">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="form-section">
                            <h5><i class="fas fa-user-edit"></i> 个人基本信息</h5>
                            <form id="detailedProfileForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="real_name" class="form-label">真实姓名 *</label>
                                        <input type="text" class="form-control" id="real_name" name="real_name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="student_id" class="form-label">学号/工号</label>
                                        <input type="text" class="form-control" id="student_id" name="student_id" placeholder="学生填学号，教师填工号">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="major" class="form-label">专业/部门</label>
                                        <select class="form-select" id="major" name="major">
                                            <option value="">请选择</option>
                                            <option value="计算机科学">计算机科学</option>
                                            <option value="软件工程">软件工程</option>
                                            <option value="人工智能">人工智能</option>
                                            <option value="数据科学">数据科学</option>
                                            <option value="网络工程">网络工程</option>
                                            <option value="信息安全">信息安全</option>
                                            <option value="电子信息工程">电子信息工程</option>
                                            <option value="通信工程">通信工程</option>
                                            <option value="机械工程">机械工程</option>
                                            <option value="电气工程">电气工程</option>
                                            <option value="土木工程">土木工程</option>
                                            <option value="建筑学">建筑学</option>
                                            <option value="工商管理">工商管理</option>
                                            <option value="市场营销">市场营销</option>
                                            <option value="会计学">会计学</option>
                                            <option value="金融学">金融学</option>
                                            <option value="经济学">经济学</option>
                                            <option value="英语">英语</option>
                                            <option value="日语">日语</option>
                                            <option value="法学">法学</option>
                                            <option value="医学">医学</option>
                                            <option value="教务处">教务处</option>
                                            <option value="学生处">学生处</option>
                                            <option value="计算机学院">计算机学院</option>
                                            <option value="文学院">文学院</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="grade" class="form-label">年级/职称</label>
                                        <select class="form-select" id="grade" name="grade">
                                            <option value="">请选择</option>
                                            <option value="大一">大一</option>
                                            <option value="大二">大二</option>
                                            <option value="大三">大三</option>
                                            <option value="大四">大四</option>
                                            <option value="研一">研一</option>
                                            <option value="研二">研二</option>
                                            <option value="研三">研三</option>
                                            <option value="博士生">博士生</option>
                                            <option value="助教">助教</option>
                                            <option value="讲师">讲师</option>
                                            <option value="副教授">副教授</option>
                                            <option value="教授">教授</option>
                                            <option value="行政人员">行政人员</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="gender" class="form-label">性别</label>
                                        <select class="form-select" id="gender" name="gender">
                                            <option value="">请选择性别</option>
                                            <option value="男">男</option>
                                            <option value="女">女</option>
                                            <option value="其他">其他</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">手机号</label>
                                        <input type="tel" class="form-control" id="phone" name="phone"
                                               pattern="[0-9]{11}" placeholder="11位手机号码">
                                        <div class="form-text">请输入11位手机号码</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="bio" class="form-label">个人简介</label>
                                    <textarea class="form-control" id="bio" name="bio" rows="4"
                                              placeholder="介绍一下你自己，兴趣爱好，特长等..." maxlength="200"></textarea>
                                    <div class="form-text">
                                        <span id="bioCount">0</span>/200 字符
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 保存详细资料
                                </button>
                                <div id="detailedProfileMessage" class="mt-2"></div>
                            </form>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-body text-center">
                                <h5 class="card-title mb-3">个人头像</h5>
                                <div class="mb-3">
                                    <div class="avatar-upload d-inline-block" onclick="document.getElementById('avatarUploadDetailed').click()">
                                        <img id="avatarPreviewDetailed" src="/static/images/default.jpg"
                                             class="rounded-circle border" style="width: 150px; height: 150px; object-fit: cover;">
                                    </div>
                                    <input type="file" id="avatarUploadDetailed" accept="image/*" style="display: none;"
                                           onchange="previewAvatar(this)">
                                </div>
                                <div class="avatar-upload-btn mb-2">
                                    <button class="btn btn-outline-primary">
                                        <i class="fas fa-upload"></i> 选择图片
                                    </button>
                                    <input type="file" id="avatarUploadBtn" accept="image/*" onchange="previewAvatar(this)">
                                </div>
                                <button class="btn btn-primary" onclick="uploadAvatar()">
                                    <i class="fas fa-cloud-upload-alt"></i> 上传头像
                                </button>
                                <div class="form-text mt-2">支持 JPG, PNG 格式，最大 2MB</div>
                                <div id="avatarMessage" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">账户信息</h5>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <strong>用户名：</strong>
                                        <span id="infoUsername"></span>
                                    </li>
                                    <li class="mb-2">
                                        <strong>用户ID：</strong>
                                        <span id="infoUserId"></span>
                                    </li>
                                    <li class="mb-2">
                                        <strong>身份：</strong>
                                        <span id="infoRole">普通用户</span>
                                    </li>
                                    <li class="mb-2">
                                        <strong>邮箱：</strong>
                                        <span id="infoEmail"></span>
                                    </li>
                                    <li class="mb-2">
                                        <strong>注册时间：</strong>
                                        <span id="infoCreatedAt"></span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="passwordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">当前密码</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">确认新密码</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div class="form-text mb-3">
                            密码要求：至少8个字符，包含字母和数字
                        </div>
                        <div id="passwordMessage"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updatePassword()">确认修改</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentUserRole = 'student';
        // 检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setupEventListeners();
        });
        // 设置事件监听器
        function setupEventListeners() {
            // 个人简介字数统计
            const bioElement = document.getElementById('bio');
            if (bioElement) {
                bioElement.addEventListener('input', function() {
                    const countElement = document.getElementById('bioCount');
                    if (countElement) {
                        countElement.textContent = this.value.length;
                    }
                });
            }
            // 详细资料表单提交
            const detailedForm = document.getElementById('detailedProfileForm');
            if (detailedForm) {
                detailedForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const data = {
                        real_name: document.getElementById('real_name').value,
                        student_id: document.getElementById('student_id').value,
                        major: document.getElementById('major').value,
                        grade: document.getElementById('grade').value,
                        gender: document.getElementById('gender').value,
                        phone: document.getElementById('phone').value,
                        email: document.getElementById('email').value,
                        bio: document.getElementById('bio').value
                    };
                    fetch('/api/user/profile/detailed', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(result => {
                        const messageDiv = document.getElementById('detailedProfileMessage');
                        if (result.success) {
                            messageDiv.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> ${result.message}
                                </div>
                            `;
                            loadDetailedProfile(); // 重新加载以更新显示
                        } else {
                            messageDiv.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i> ${result.error}
                                </div>
                            `;
                        }
                        setTimeout(() => {
                            if (messageDiv) messageDiv.innerHTML = '';
                        }, 3000);
                    })
                    .catch(error => {
                        console.error('更新详细资料失败:', error);
                        const messageDiv = document.getElementById('detailedProfileMessage');
                        if (messageDiv) {
                            messageDiv.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i> 更新失败，请重试
                                </div>
                            `;
                        }
                    });
                });
            }
            // 个人资料表单提交（邮箱更新）
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const data = { email: document.getElementById('email').value };
                    fetch('/api/user/profile', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    })
                    .then(response => response.json())
                    .then(result => {
                        const messageDiv = document.getElementById('profileMessage');
                        if (result.success) {
                            messageDiv.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> ${result.message}
                                </div>
                            `;
                            loadUserProfile();
                        } else {
                            messageDiv.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i> ${result.error}
                                </div>
                            `;
                        }
                        setTimeout(() => {
                            if (messageDiv) messageDiv.innerHTML = '';
                        }, 3000);
                    })
                    .catch(error => {
                        console.error('更新个人资料失败:', error);
                        const messageDiv = document.getElementById('profileMessage');
                        if (messageDiv) {
                            messageDiv.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i> 更新失败，请重试
                                </div>
                            `;
                        }
                    });
                });
            }
            // 标签页切换事件 - 加载我的帖子
            const myPostsTab = document.getElementById('my-posts-tab');
            if (myPostsTab) {
                myPostsTab.addEventListener('shown.bs.tab', function() {
                    loadMyPosts();
                });
            }
        }
        // 检查登录状态
        function checkLoginStatus() {
            fetch('/api/current-user',{
                credentials: 'include'
            })
                .then(response => {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        currentUserRole = result.data.role || 'student';
                        loadUserProfile();
                        loadJoinedActivities();
                        loadDetailedProfile();
                        loadFavorites();
                        checkAvatarStatus();
                        // 显示教师专属功能
                        if (currentUserRole === 'teacher') {
                            document.getElementById('reviewNavItem').style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('检查登录状态失败:', error);
                    window.location.href = '/login';
                });
        }
        // 加载用户基本资料
        function loadUserProfile() {
            fetch('/api/user/profile',{
                credentials: 'include'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const data = result.data;
                        updateBasicProfile(data);
                    }
                })
                .catch(error => {
                    console.error('加载用户资料失败:', error);
                });
        }
        // 加载用户详细资料
        function loadDetailedProfile() {
            fetch('/api/user/profile/detailed',{
                credentials: 'include'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const data = result.data;
                        updateDetailedProfile(data);
                        updateProfileCompletion(data);
                    } else {
                        console.error('加载详细资料失败:', result.error);
                    }
                })
                .catch(error => {
                    console.error('获取详细资料失败:', error);
                });
        }
        // 加载我的帖子
        function loadMyPosts() {
            const loadingElement = document.getElementById('postsLoading');
            loadingElement.style.display = 'block';
            fetch('/api/posts',{
                credentials: 'include'
            })
                .then(response => response.json())
                .then(result => {
                    loadingElement.style.display = 'none';
                    if (result.success) {
                        const myPosts = result.data.filter(post => post.author_id === sessionStorage.getItem('user_id'));
                        displayMyPosts(myPosts);
                    }
                })
                .catch(error => {
                    console.error('加载我的帖子失败:', error);
                    loadingElement.innerHTML = '<p class="text-danger">加载失败，请刷新页面重试</p>';
                });
        }
        // 更新基本资料显示
        function updateBasicProfile(data) {
            // 存储用户ID到sessionStorage
            sessionStorage.setItem('user_id', data.user_id || session['user_id']);
            document.getElementById('usernameDisplay').textContent = data.username;
            document.getElementById('userEmail').textContent = data.email || '未设置';
            document.getElementById('email').value = data.email || '';
            document.getElementById('joinDate').textContent = data.created_at || '';
            document.getElementById('joinDateSettings').value = data.created_at || '';
            document.getElementById('joinedCount').textContent = data.stats?.activities_joined || 0;
            document.getElementById('totalActivities').textContent = data.stats?.total_activities || 0;
            document.getElementById('favoritesCount').textContent = data.stats?.favorites_count || 0;
            // 显示身份徽章
            const roleBadge = document.getElementById('userRoleBadge');
            if (currentUserRole === 'teacher') {
                roleBadge.className = 'badge badge-teacher mb-2';
                roleBadge.textContent = '教师身份';
            } else {
                roleBadge.className = 'badge badge-student mb-2';
                roleBadge.textContent = '学生身份';
            }
            // 计算注册天数
            if (data.created_at) {
                const createdDate = new Date(data.created_at);
                const today = new Date();
                const diffTime = Math.abs(today - createdDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                document.getElementById('accountDays').textContent = diffDays;
            }
            // 更新头像
            if (data.avatar) {
                document.getElementById('avatarPreview').src = data.avatar;
                document.getElementById('avatarPreview').style.display = 'block';
                document.getElementById('avatarIcon').style.display = 'none';
                document.getElementById('avatarPreviewDetailed').src = data.avatar;
            }
        }
        // 更新详细资料显示
        function updateDetailedProfile(data) {
            // 填充表单数据
            document.getElementById('real_name').value = data.real_name || '';
            document.getElementById('student_id').value = data.student_id || '';
            document.getElementById('major').value = data.major || '';
            document.getElementById('grade').value = data.grade || '';
            document.getElementById('gender').value = data.gender || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('bio').value = data.bio || '';
            document.getElementById('bioCount').textContent = (data.bio || '').length;
            // 更新账户信息
            document.getElementById('infoUsername').textContent = data.username || '';
            document.getElementById('infoUserId').textContent = data.user_id || '';
            document.getElementById('infoRole').textContent = currentUserRole === 'teacher' ? '教师' : '学生';
            document.getElementById('infoEmail').textContent = data.email || '';
            document.getElementById('infoCreatedAt').textContent = data.created_at || '';
            // 更新顶部信息
            document.getElementById('userMajor').textContent = data.major ? `专业/部门: ${data.major}` : '';
            document.getElementById('userGrade').textContent = data.grade ? `年级/职称: ${data.grade}` : '';
            document.getElementById('userBio').textContent = data.bio || '暂无简介';
            // 更新头像
            if (data.avatar && data.avatar !== '/static/images/default.jpg') {
                document.getElementById('avatarPreview').src = data.avatar;
                document.getElementById('avatarPreview').style.display = 'block';
                document.getElementById('avatarIcon').style.display = 'none';
                document.getElementById('avatarPreviewDetailed').src = data.avatar;
            }
        }
        // 更新资料完整度
        function updateProfileCompletion(profile) {
            const checklist = [
                { field: 'real_name', text: '真实姓名', weight: 20 },
                { field: 'email', text: '邮箱地址', weight: 20 },
                { field: 'major', text: '专业/部门', weight: 20 },
                { field: 'phone', text: '联系方式', weight: 15 },
                { field: 'bio', text: '个人简介', weight: 15 },
                { field: 'avatar', text: '个人头像', weight: 10 }
            ];
            let totalScore = 0;
            let maxScore = 100;
            const container = document.getElementById('profileChecklist');
            if (!container) return;
            container.innerHTML = '';
            checklist.forEach(item => {
                const isCompleted = profile[item.field] &&
                    (item.field === 'avatar' ? profile[item.field] !== '/static/images/default.jpg' : profile[item.field].trim() !== '');
                if (isCompleted) totalScore += item.weight;
                const itemDiv = document.createElement('div');
                itemDiv.className = `completion-item ${isCompleted ? 'completed' : ''}`;
                itemDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${item.text}</span>
                        <i class="fas fa-${isCompleted ? 'check' : 'times'}"></i>
                    </div>
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar ${isCompleted ? 'bg-success' : 'bg-light'}"
                             style="width: ${item.weight}%"></div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
            // 更新进度条和百分比
            const percentage = Math.round((totalScore / maxScore) * 100);
            const completionElement = document.getElementById('profileCompletion');
            const completionBar = document.getElementById('completionBar');
            if (completionElement) completionElement.textContent = `${percentage}%`;
            if (completionBar) {
                completionBar.style.width = `${percentage}%`;
                completionBar.className = `progress-bar ${percentage >= 80 ? 'bg-success' : percentage >= 50 ? 'bg-warning' : 'bg-danger'}`;
            }
        }
        // 加载已参与活动
        function loadJoinedActivities() {
            fetch('/api/user/joined-activities',{
                credentials: 'include'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        displayJoinedActivities(result.data);
                        const loadingElement = document.getElementById('joinedLoading');
                        if (loadingElement) loadingElement.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('加载已参与活动失败:', error);
                    const loadingElement = document.getElementById('joinedLoading');
                    if (loadingElement) {
                        loadingElement.innerHTML = '<p class="text-danger">加载失败，请刷新页面重试</p>';
                    }
                });
        }
        // 加载收藏活动
        function loadFavorites() {
            fetch('/api/user/favorites',{
                credentials: 'include'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        displayFavorites(result.data);
                        const loadingElement = document.getElementById('favoritesLoading');
                        if (loadingElement) loadingElement.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('加载收藏活动失败:', error);
                    const loadingElement = document.getElementById('favoritesLoading');
                    if (loadingElement) {
                        loadingElement.innerHTML = '<p class="text-danger">加载失败，请刷新页面重试</p>';
                    }
                });
        }
        // 显示已参与活动
        function displayJoinedActivities(activities) {
            const container = document.getElementById('joinedActivitiesList');
            if (!container) return;
            container.innerHTML = '';
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            您还没有参与任何活动，快去首页看看吧！
                            <a href="/" class="btn btn-sm btn-outline-primary ms-2">浏览活动</a>
                        </div>
                    </div>
                `;
                return;
            }
            activities.forEach(activity => {
                const card = `
                    <div class="col-md-6 mb-3">
                        <div class="card activity-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-1">${activity.title}</h5>
                                    <span class="badge badge-custom">${activity.type}</span>
                                </div>
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-clock"></i> ${activity.time}<br>
                                    <i class="fas fa-map-marker-alt"></i> ${activity.location}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-users"></i> ${activity.participants.length}人参与
                                    </small>
                                    <button class="btn btn-outline-danger btn-sm" onclick="leaveActivity(${activity.id})">
                                        <i class="fas fa-times"></i> 取消报名
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }
        // 显示收藏活动
        function displayFavorites(activities) {
            const container = document.getElementById('favoritesList');
            if (!container) return;
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            您还没有收藏任何活动
                            <a href="/" class="btn btn-sm btn-outline-primary ms-2">去收藏活动</a>
                        </div>
                    </div>
                `;
                return;
            }
            container.innerHTML = '';
            activities.forEach(activity => {
                const card = `
                    <div class="col-md-6 mb-3">
                        <div class="card activity-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-1">${activity.title}</h5>
                                    <span class="badge badge-custom">${activity.type}</span>
                                </div>
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-clock"></i> ${activity.time}<br>
                                    <i class="fas fa-map-marker-alt"></i> ${activity.location}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-users"></i> ${activity.participants.length}人参与
                                    </small>
                                    <button class="btn btn-outline-warning btn-sm" onclick="unfavoriteActivity(${activity.id})">
                                        <i class="fas fa-star"></i> 取消收藏
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }
        // 显示我的帖子
        function displayMyPosts(posts) {
            const container = document.getElementById('myPostsList');
            if (!container) return;
            container.innerHTML = '';
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i>
                            您还没有发布任何帖子
                            <a href="/" class="btn btn-sm btn-outline-primary ms-2">去发布帖子</a>
                        </div>
                    </div>
                `;
                return;
            }
            posts.forEach(post => {
                let statusBadge = '';
                if (post.review_status === 'pending') {
                    statusBadge = '<span class="badge bg-warning ms-2">待审核</span>';
                } else if (post.review_status === 'approved') {
                    statusBadge = '<span class="badge bg-success ms-2">已通过</span>';
                } else {
                    statusBadge = '<span class="badge bg-danger ms-2">已驳回</span>';
                }
                const card = `
                    <div class="col-md-6 mb-3">
                        <div class="card activity-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="card-title mb-1">${post.title} ${statusBadge}</h5>
                                    <span class="badge badge-custom">${post.category}</span>
                                </div>
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-clock"></i> ${post.created_at}
                                </p>
                                <p class="card-text">${post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-tags"></i> ${post.tags.join(', ') || '无标签'}
                                    </small>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteMyPost(${post.id})">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }
        // 取消报名
        function leaveActivity(activityId) {
            if (!confirm('确定要取消报名吗？')) return;
            fetch(`/api/activities/${activityId}/leave`, { method: 'POST' },{credentials: 'include'})
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        loadJoinedActivities();
                        loadUserProfile(); // 刷新统计数据
                    } else {
                        alert(result.error);
                    }
                })
                .catch(error => {
                    console.error('取消报名失败:', error);
                    alert('操作失败，请重试');
                });
        }
        // 取消收藏
        function unfavoriteActivity(activityId) {
            if (!confirm('确定要取消收藏吗？')) return;
            fetch(`/api/activities/${activityId}/favorite`, { method: 'POST' },{credentials: 'include'})
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        loadFavorites();
                        loadUserProfile(); // 刷新统计数据
                    } else {
                        alert(result.error);
                    }
                })
                .catch(error => {
                    console.error('取消收藏失败:', error);
                    alert('操作失败，请重试');
                });
        }
        // 删除我的帖子
        function deleteMyPost(postId) {
            if (!confirm('确定要删除该帖子吗？删除后不可恢复！')) return;
            fetch(`/api/posts/${postId}`, { method: 'DELETE' },{credentials: 'include'})
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        loadMyPosts();
                    } else {
                        alert(result.error);
                    }
                })
                .catch(error => {
                    console.error('删除帖子失败:', error);
                    alert('操作失败，请重试');
                });
        }
        // 头像预览
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                // 检查文件大小（2MB限制）
                if (file.size > 2 * 1024 * 1024) {
                    alert('文件太大，请选择小于2MB的图片');
                    return;
                }
                // 检查文件类型
                if (!file.type.match('image.*')) {
                    alert('请选择图片文件（JPG/PNG格式）');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                    document.getElementById('avatarPreview').style.display = 'block';
                    document.getElementById('avatarIcon').style.display = 'none';
                    document.getElementById('avatarPreviewDetailed').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        // 检查头像状态
        function checkAvatarStatus() {
            fetch('/api/user/avatar',{credentials: 'include'})
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data.has_custom_avatar) {
                        // 如果有自定义头像，更新所有头像显示
                        const avatarUrl = result.data.avatar_url;
                        document.getElementById('avatarPreview').src = avatarUrl;
                        document.getElementById('avatarPreviewDetailed').src = avatarUrl;
                        document.getElementById('avatarPreview').style.display = 'block';
                        document.getElementById('avatarIcon').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('检查头像状态失败:', error);
                });
        }
        // 上传头像（完整实现）
        function uploadAvatar() {
            const fileInput = document.getElementById('avatarUploadBtn');
            if (!fileInput.files[0]) {
                alert('请先选择图片文件');
                return;
            }
            const formData = new FormData();
            formData.append('avatar', fileInput.files[0]);
            // 显示上传中状态
            const messageDiv = document.getElementById('avatarMessage');
            messageDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">上传中...</span>
                    </div>
                    正在上传头像...
                </div>
            `;
            fetch('/api/user/avatar', {
                method: 'POST',
                body: formData,
                // 注意：不要设置 Content-Type header，浏览器会自动设置 multipart/form-data
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    messageDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> ${result.message}
                        </div>
                    `;
                    // 更新所有头像预览
                    if (result.data && result.data.avatar_url) {
                        const avatarUrl = result.data.avatar_url;
                        // 更新页面上的所有头像显示
                        document.getElementById('avatarPreview').src = avatarUrl;
                        document.getElementById('avatarPreviewDetailed').src = avatarUrl;
                        document.getElementById('avatarPreview').style.display = 'block';
                        document.getElementById('avatarIcon').style.display = 'none';
                        // 重新加载用户资料以更新显示
                        loadUserProfile();
                        loadDetailedProfile();
                    }
                } else {
                    messageDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> ${result.error}
                        </div>
                    `;
                }
                // 3秒后清除消息
                setTimeout(() => {
                    if (messageDiv) messageDiv.innerHTML = '';
                }, 3000);
            })
            .catch(error => {
                console.error('上传头像失败:', error);
                messageDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> 上传失败，请重试
                    </div>
                `;
            });
        }
        // 修改密码功能
        function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (!currentPassword || !newPassword || !confirmPassword) {
                document.getElementById('passwordMessage').innerHTML = `
                    <div class="alert alert-danger">请填写所有字段</div>
                `;
                return;
            }
            if (newPassword !== confirmPassword) {
                document.getElementById('passwordMessage').innerHTML = `
                    <div class="alert alert-danger">两次输入的新密码不一致</div>
                `;
                return;
            }
            if (newPassword.length < 8) {
                document.getElementById('passwordMessage').innerHTML = `
                    <div class="alert alert-danger">密码长度至少8位</div>
                `;
                return;
            }
            // 调用后端API修改密码
            fetch('/api/user/change-password', {credentials: 'include'},{
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('passwordMessage').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> ${result.message}
                        </div>
                    `;
                    // 清空表单
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    // 3秒后关闭模态框
                    setTimeout(() => {
                        const modalElement = document.getElementById('changePasswordModal');
                        if (modalElement) {
                            const modal = bootstrap.Modal.getInstance(modalElement);
                            if (modal) modal.hide();
                        }
                    }, 3000);
                } else {
                    document.getElementById('passwordMessage').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> ${result.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('修改密码失败:', error);
                document.getElementById('passwordMessage').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> 修改失败，请重试
                    </div>
                `;
            });
        }
        // 登出功能
        function logout() {
            fetch('/api/logout', { method: 'POST' },{credentials: 'include'})
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        sessionStorage.removeItem('user_id');
                        window.location.href = '/login';
                    }
                });
        }
    </script>
</body>
</html>